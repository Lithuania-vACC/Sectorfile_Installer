<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <Package Name="vACC Lithuania Sectorfile Installer"
           Language="1033"
           Version="1.0.0.0"
           Manufacturer="vACC Lithuania"
           Id="vACCLithuania.SectorfileInstaller"
           Compressed="yes"
           Scope="perUser">

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <MediaTemplate EmbedCab="yes" />

    <Property Id="INSTALLFOLDER">
      <RegistrySearch Id="FindInstallLocation"
                      Root="HKCU"
                      Key="Software\vACC Lithuania\Sectorfile Installer"
                      Name="InstallLocation"
                      Type="raw" />
    </Property>

    <SetDirectory Id="INSTALLFOLDER" Value="[LocalAppDataFolder]vACC Lithuania Sectorfile Installer" Sequence="both" />

    <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />

    <Property Id="CREATE_DESKTOP_SHORTCUT" Value="1" />
    <Property Id="CREATE_STARTMENU_SHORTCUT" Value="1" />

    <StandardDirectory Id="LocalAppDataFolder">
      <Directory Id="INSTALLFOLDER" Name="vACC Lithuania Sectorfile Installer" />
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="vACC Lithuania" />
    </StandardDirectory>

    <StandardDirectory Id="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="*" Condition="CREATE_DESKTOP_SHORTCUT = 1">
        <Shortcut Id="DesktopShortcutId"
                  Name="vACC Lithuania"
                  Target="[INSTALLFOLDER]main.exe"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="AppIcon.exe"
                  IconIndex="0" />
        <RegistryValue Root="HKCU"
                       Key="Software\vACC Lithuania\Sectorfile Installer"
                       Name="DesktopShortcut"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </StandardDirectory>

    <!-- Application files will be included via Files element (replaces heat) -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="RegistryEntries" Guid="*">
        <RegistryValue Root="HKCU"
                       Key="Software\vACC Lithuania\Sectorfile Installer"
                       Name="InstallLocation"
                       Type="string"
                       Value="[INSTALLFOLDER]"
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- Harvest all files from main.dist directory -->
    <ComponentGroup Id="HarvestedFiles" Directory="INSTALLFOLDER">
      <Files Include="main.dist\**" />
    </ComponentGroup>

    <!-- Start Menu shortcut -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="StartMenuShortcut" Guid="*" Condition="CREATE_STARTMENU_SHORTCUT = 1">
        <Shortcut Id="StartMenuShortcutId"
                  Name="vACC Lithuania"
                  Target="[INSTALLFOLDER]main.exe"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="AppIcon.exe"
                  IconIndex="0" />
        <RemoveFolder Id="RemoveStartMenuFolder" On="uninstall" />
        <RegistryValue Root="HKCU"
                       Key="Software\vACC Lithuania\Sectorfile Installer"
                       Name="StartMenuShortcut"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- Icon -->
    <Icon Id="AppIcon.exe" SourceFile="main.dist\main.exe" />

    <!-- Features -->
    <Feature Id="ProductFeature" Title="vACC Lithuania Sectorfile Installer" Level="1">
      <ComponentGroupRef Id="HarvestedFiles" />
      <ComponentRef Id="RegistryEntries" />
      <ComponentRef Id="StartMenuShortcut" />
      <ComponentRef Id="DesktopShortcut" />
    </Feature>

    <!-- Custom UI -->
    <!-- This custom UI integrates with WixUI_InstallDir for shortcut selection -->
    <UI>
      <!-- Skip license dialog: go directly from Welcome to InstallDir -->
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" Order="2" />
      <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" Order="2" />

      <!-- Navigate from InstallDir to custom shortcut dialog -->
      <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="ShortcutCustomizeDlg" Order="4" />
      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="ShortcutCustomizeDlg" Order="2" Condition="NOT Installed OR WixUI_InstallMode = &quot;Change&quot;" />

      <Dialog Id="ShortcutCustomizeDlg" Width="370" Height="270" Title="[ProductName] Setup">
        <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="{\WixUI_Font_Title}Customize Installation" />
        <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes" Text="Choose installation options" />
        <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="!(loc.InstallDirDlgBannerBitmap)" />
        <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />

        <Control Id="DesktopShortcutCheckBox" Type="CheckBox" X="20" Y="60" Width="290" Height="18"
                 Property="CREATE_DESKTOP_SHORTCUT" CheckBoxValue="1" Text="Create a desktop shortcut" />

        <Control Id="StartMenuShortcutCheckBox" Type="CheckBox" X="20" Y="85" Width="290" Height="18"
                 Property="CREATE_STARTMENU_SHORTCUT" CheckBoxValue="1" Text="Create a Start Menu shortcut" />

        <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />
        <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="!(loc.WixUIBack)">
          <Publish Event="NewDialog" Value="InstallDirDlg" />
        </Control>
        <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="!(loc.WixUINext)">
          <Publish Event="NewDialog" Value="VerifyReadyDlg" />
        </Control>
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="!(loc.WixUICancel)">
          <Publish Event="SpawnDialog" Value="CancelDlg" />
        </Control>
      </Dialog>
    </UI>
  </Package>
</Wix>